CREATE DEFINER=`root`@`localhost` PROCEDURE `GERA_NOTA`(
NUMERO_PEDIDO INTEGER
)
BEGIN
DECLARE DATA_PEDIDO DATE;
DECLARE CLIENTE INTEGER;
DECLARE TIPO_FESTA INTEGER;
DECLARE TEMP_PRODUTO INTEGER;
DECLARE TEMP_VALOR_UNITARIO FLOAT;
DECLARE TEMP_VALOR_TOTAL FLOAT;
DECLARE TEMP_QUANTIDADE INTEGER;
DECLARE done INT DEFAULT FALSE;
DECLARE CURSOR_ITENS CURSOR FOR
		(SELECT PI_PRODUTO,
				PI_VALOR_UNITARIO,
                PI_VALOR_TOTAL,
                PI_QUANTIDADE
        FROM PEDIDO_ITEM
        WHERE PI_PEDIDO = NUMERO_PEDIDO);
DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
	OPEN CURSOR_ITENS;

	SELECT PED_DATA,PED_CLIENTE_ID,PED_TIPO_FESTA FROM PEDIDO
	WHERE PED_ID = NUMERO_PEDIDO
	INTO DATA_PEDIDO, CLIENTE,TIPO_FESTA;
    
    INSERT INTO NOTA_FISCAL(NF_ID,NF_DATA,NF_CLIENTE,NF_TIPO_FESTA,NF_PEDIDO)
	VALUES(NUMERO_PEDIDO,DATA_PEDIDO,CLIENTE,TIPO_FESTA,NUMERO_PEDIDO);

	LOOP_ITENS :LOOP
		FETCH CURSOR_ITENS INTO TEMP_PRODUTO,TEMP_VALOR_UNITARIO,TEMP_VALOR_TOTAL,TEMP_QUANTIDADE;
        IF done THEN
			LEAVE LOOP_ITENS;
		END IF;      
		INSERT INTO NOTA_ITEM(NI_PEDIDO,NI_PRODUTO,NI_VALOR_UNITARIO,NI_VALOR_TOTAL,NI_QUANTIDADE)
        VALUES(NUMERO_PEDIDO,TEMP_PRODUTO,TEMP_VALOR_UNITARIO,TEMP_VALOR_TOTAL,TEMP_QUANTIDADE);
        
        UPDATE PEDIDO 
        SET PED_STATUS = 'F'
        WHERE PED_ID = NUMERO_PEDIDO;
        
	END LOOP LOOP_ITENS;

END
