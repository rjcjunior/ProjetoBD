CREATE DEFINER=`root`@`localhost` PROCEDURE `USAR_PACOTE`(
NUMERO_PACOTE INTEGER,
CLIENTE INTEGER,
DATA_PEDIDO DATE)
BEGIN
DECLARE PEDIDO INTEGER;
DECLARE TIPO_FESTA INTEGER;
DECLARE TEMP_PRODUTO INTEGER;
DECLARE TEMP_VALOR_UNITARIO FLOAT;
DECLARE TEMP_VALOR_TOTAL FLOAT;
DECLARE TEMP_QUANTIDADE INTEGER;
DECLARE done INT DEFAULT FALSE;
DECLARE CURSOR_ITENS CURSOR FOR
		(SELECT IPAC_PRODUTO,
				IPAC_VALOR_UNITARIO,
                IPAC_VALOR_TOTAL,
                IPAC_QUANTIDADE
        FROM PACOTE_ITEM
        WHERE IPAC_PACOTE = NUMERO_PACOTE);
DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
	OPEN CURSOR_ITENS;

	SELECT PAC_TIPO_FESTA FROM PACOTE 
    WHERE PAC_ID = NUMERO_PACOTE
	INTO TIPO_FESTA;
    
    INSERT INTO PEDIDO(PED_DATA,PED_CLIENTE_ID,PED_TIPO_FESTA,PED_STATUS)
	VALUES(DATA_PEDIDO,CLIENTE,TIPO_FESTA,'A');
    
    SELECT PED_ID FROM PEDIDO
    WHERE PED_DATA = DATA_PEDIDO AND PED_CLIENTE_ID = CLIENTE AND
		  PED_TIPO_FESTA = TIPO_FESTA
    INTO PEDIDO;      
          

	LOOP_ITENS :LOOP
		FETCH CURSOR_ITENS INTO TEMP_PRODUTO,TEMP_VALOR_UNITARIO,TEMP_VALOR_TOTAL,TEMP_QUANTIDADE;
        IF done THEN
			LEAVE LOOP_ITENS;
		END IF;      
		INSERT INTO PEDIDO_ITEM(PI_PEDIDO,PI_PRODUTO,PI_VALOR_UNITARIO,PI_VALOR_TOTAL,PI_QUANTIDADE)
        VALUES(PEDIDO,TEMP_PRODUTO,TEMP_VALOR_UNITARIO,TEMP_VALOR_TOTAL,TEMP_QUANTIDADE);
        
    
        
	END LOOP LOOP_ITENS;

END
