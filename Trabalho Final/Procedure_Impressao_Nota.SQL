CREATE DEFINER=`root`@`localhost` PROCEDURE `IMPRIME_NOTA`(
NUMERO_NOTA INTEGER,
OUT R_DATA_NOTA DATE,
OUT R_CLIENTE_NOTA VARCHAR(100),
OUT R_TIPO_FESTA VARCHAR(60),
OUT R_ITENS TEXT)
BEGIN

DECLARE TEMP_ITENS TEXT;
DECLARE DATA_PEDIDO DATE;
DECLARE CLIENTE INTEGER;
DECLARE TIPO_FESTA INTEGER;
DECLARE TEMP_PRODUTO TEXT;
DECLARE TEMP_VALOR_UNITARIO FLOAT;
DECLARE TEMP_VALOR_TOTAL FLOAT;
DECLARE TEMP_QUANTIDADE INTEGER;
DECLARE done INT DEFAULT FALSE;
DECLARE CURSOR_ITENS CURSOR FOR
		(SELECT P_DESCRICAO,
				NI_VALOR_UNITARIO,
                NI_VALOR_TOTAL,
                NI_QUANTIDADE
        FROM NOTA_ITEM,PRODUTO
        WHERE NI_PRODUTO = P_ID
        AND NI_PEDIDO = NUMERO_NOTA);
DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
	OPEN CURSOR_ITENS;

	SELECT  NOTA_FISCAL.NF_DATA, TIPO_FESTA.TDESCRICAO_FESTA,ENTIDADE.ENT_NOME 
	FROM NOTA_FISCAL,
	 TIPO_FESTA,
     ENTIDADE
    WHERE NOTA_FISCAL.NF_TIPO_FESTA = TIPO_FESTA.TFESTA_ID
    AND NOTA_FISCAL.NF_CLIENTE = ENTIDADE.ENT_ID
    AND NOTA_FISCAL.NF_PEDIDO = 1
    INTO R_DATA_NOTA, R_CLIENTE_NOTA, R_TIPO_FESTA;
	SET TEMP_ITENS = ' ';
	LOOP_ITENS :LOOP
		FETCH CURSOR_ITENS INTO TEMP_PRODUTO,TEMP_VALOR_UNITARIO,TEMP_VALOR_TOTAL,TEMP_QUANTIDADE;
        IF done THEN
			LEAVE LOOP_ITENS;
		END IF; 
         SET TEMP_ITENS = CONCAT(TEMP_ITENS,' - PRODUTO ');        
		 SET TEMP_ITENS = CONCAT(TEMP_ITENS,TEMP_PRODUTO);
         SET TEMP_ITENS = CONCAT(TEMP_ITENS,' - VALOR UNIT√ÅRIO ');
         SET TEMP_ITENS = CONCAT(TEMP_ITENS,TEMP_VALOR_UNITARIO);

	END LOOP LOOP_ITENS;
	SET R_ITENS = TEMP_ITENS;

END
